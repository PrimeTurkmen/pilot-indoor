version: "3.8"

services:
  positioning-engine:
    build: .
    container_name: pilot-indoor-engine
    restart: unless-stopped
    ports:
      - "3080:3080"
    environment:
      # Velavu Cloud Engine (primary) â€” set your token here
      VELAVU_API_TOKEN: ${VELAVU_API_TOKEN:-}
      VELAVU_API_URL: ${VELAVU_API_URL:-https://api.velavu.com}
      VELAVU_POLL_MS: ${VELAVU_POLL_MS:-10000}
      # Channel Sounding Engine (secondary)
      MQTT_BROKER: mqtt://mosquitto:1883
      # PILOT bridge
      PILOT_API_URL: ${PILOT_API_URL:-https://your-server.pilot-gps.com}
      PILOT_API_KEY: ${PILOT_API_KEY:-}
    depends_on:
      mosquitto:
        condition: service_healthy

  mosquitto:
    image: eclipse-mosquitto:2
    container_name: pilot-indoor-mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"
    volumes:
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
    healthcheck:
      test: ["CMD", "mosquitto_pub", "-t", "healthcheck", "-m", "ok", "-q", "0"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

volumes:
  mosquitto_data:
  mosquitto_log:
